<!DOCTYPE html>
<html>
  <head>
    <title>Tabletops</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="css/bootstrap.css" rel="stylesheet" media="all">
    <link href="css/Site.css" rel="stylesheet" media="all">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script type="text/javascript">
		$(document).ready(function() {
			
			loadUsersTable();
			
			
		});
	</script>
  </head>
  <body>

  <script type="text/javascript">
  $(document).ready(function() {
		$('#title').html("PlaceCards - " + localStorage.clientName + " - "+ localStorage.venueName);
	});
  function getCookie(cname) {
		console.log("get cookie");
		var name = cname + "=";
		var decodedCookie = decodeURIComponent(document.cookie);
		var ca = decodedCookie.split(';');
		for (var i = 0; i < ca.length; i++) {
			var c = ca[i];
			while (c.charAt(0) == ' ') {
				c = c.substring(1);
			}
			if (c.indexOf(name) == 0) {
				return c.substring(name.length, c.length);
			}
		}
		return "";
	}

	function setHeader(xhr) {
		console.log("set Header");
		token = getCookie("token");
		console.log("Token: " + token);
		xhr.setRequestHeader('Authorization', 'Bearer ' + token);
	}
  function loadUsersTable(){
	  var hasSeatingArrangment = true;
	  var id = localStorage.eventId;
		if(id > 0){
			var guestsUrl = "/SchoolRestJPA/rest/tabletopservices/events/" + id + "/guests";
	  
		 $.ajax({ 
			   type: "GET",  
		       url: guestsUrl,  
		       dataType: "json",
		       statusCode : {
					401 : function(response) {
						$('#page-message').html("You must Login first");
						alert("Please login to access this page");
			        	document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
					},
					405 : function(response) {
						$('#page-message').html(
								"Access to the page forbiden");
						alert("Please login to access this page");
						document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
					}
				},
		       success: function(resp){  
		         // we have the response
		       
		         $('#guest_placecard').html("");
		         var placecard;
		         var guests = [];
				 var keys = [];
		         $.each(resp, function(i, guest){
		        	 if(guest.guestFitness == null){
							console.log("Guest fitness null");
							hasSeatingArrangment = false;
							$('#guest_placecards').html("<h1>No Seating Arrangement has been generated</h1");
							return false;
		        	 }
		        	if (guest.eventTableNumber == 999){
		        		alert("No table for guest " + guest.name);	
		        	}else{
		        		guests[guest.name] = guest;
						keys.push(guest.name);
		        		/*if (col == 0) {
			        		$('#guest_placecards').append('<div class="row">');
			        	}
	       	        	placecard='<div class="col-sm-4 col-md-4 col-lg-4">'
	       	        		+ '<div class="thumbnail placecard">'
	       	        		+ '<h2 class="text-center text-primary text-capitalize">'+guest.name+'</h2>'
	       					+'<h1 class="text-center text-primary">'+guest.eventTableNumber+'</h1>'
	       					+'<h3 class="text-center text-muted">'+guest.clientRelationship+'</h3>'
	       					+'</div></div>';
	       		         $('#guest_placecards').append(placecard);	
	       		         col = col + 1;
	       		         if(col == 3){
	      		        	$('#guest_placecards').append('</div>');
	      		        	col = 0;
	     		         }	*/
		        	}
		         });
	        	if(hasSeatingArrangment)
				{ 
	        		keys.sort();
			        var col = 0;
			        
	        		for (var i = 0; i < keys.length; i++) {
						var key = keys[i];
						var guest = guests[key];
						
						if (col == 0) {
			        		$('#guest_placecards').append('<div class="row">');
			        	}
	       	        	placecard='<div class="col-sm-4 col-md-4 col-lg-4">'
	       	        		+ '<div class="thumbnail placecard">'
	       	        		+ '<h2 class="text-center text-primary text-capitalize">'+guest.name+'</h2>'
	       					+'<h1 class="text-center text-primary">'+guest.eventTableNumber+'</h1>'
	       					+'<h3 class="text-center text-muted">'+guest.clientRelationship+'</h3>'
	       					+'</div></div>';
	       		         $('#guest_placecards').append(placecard);	
	       		         col = col + 1;
	       		         if(col == 3){
	      		        	$('#guest_placecards').append('</div>');
	      		        	col = 0;
	     		         }
	        		}
				}
		       },
		       error: function (jqXHR, exception) {
		    	    alert("There was an error loading the placecards.");
		    	    console.log("Error" + jqXHR.responseText);
		    	    console.log(exception.responseText);
		    	  },
		 	       beforeSend : setHeader  
			});
		}
	}
  </script>
  
    <div id="nav-container"></div>
   
    <div class="container">
    <div class="row">
    <div class="col-sm-12 col-md-12 col-lg-12">
	<h2 id="title"></h2>
	<div id="tables-nav"></div>
	
    	<div class="row">
    		<h3 >Placecards</h3>
    			<button class="btn btn-xs btn-info pull-right" onclick="window.print();">Print</button>
   		 </div>
    	</div>
    	</div>
    	
    	<div class="row">
    	<div class="panel panel-default"> 
  			<div class="panel-body">
		<div class="placecard-section" id="guest_placecards"></div>
		</div>
		</div>
		</div>
	</div>
	
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
      <script type="text/javascript">
  $(document).ready(function() {
 		$('#nav-container').load('nav.html');
 		localStorage.tablesNavSelect = "btnPlaceCard";
		$('#tables-nav').load('TablesNav.html');
		
// 		$('TablesNav.html #tables-nav').load("#btnPlaceCard").addClass('active');
// 		console.log($("TablesNav.html #btnPlaceCard").attr('class'));
	});
  </script>
  </body>
</html>