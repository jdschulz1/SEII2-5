<!DOCTYPE html>
<html>
<head>
<title>Tabletops</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap -->
<link href="css/bootstrap.css" rel="stylesheet" media="screen">
<link href="css/Site.css" rel="stylesheet" media="screen">
<script	src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script> 
<script type="text/javascript">
	$(document).ready(function() {
		$('#nav-container').load('nav.html');

		loadClientsTable();
	});
	$('#clientsNav').addClass('active');
</script>

<script type="text/javascript">
	function getCookie(cname) {
		console.log("get cookie");
		var name = cname + "=";
		var decodedCookie = decodeURIComponent(document.cookie);
		var ca = decodedCookie.split(';');
		for (var i = 0; i < ca.length; i++) {
			var c = ca[i];
			while (c.charAt(0) == ' ') {
				c = c.substring(1);
			}
			if (c.indexOf(name) == 0) {
				return c.substring(name.length, c.length);
			}
		}
		return "";
	}
	
	function setHeader(xhr) {
		console.log("set Header");
		token = getCookie("token");
		console.log("Token: " + token);
		xhr.setRequestHeader('Authorization', 'Bearer ' + token);
	}
	function loadClientsTable() {
		$
				.ajax({
					type : "GET",
					url : "/SchoolRestJPA/rest/tabletopservices/clients",
					dataType : "json",
					statusCode : {
						401 : function(response) {
							$('#page-message').html("You must Login first");
							alert("Please login to access this page");
				        	document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
						},
						405 : function(response) {
							$('#page-message').html(
									"Access to the page forbiden");
							alert("Please login to access this page");
							document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
						}
					},
					success : function(resp) {
						// we have the response  

						$('#clientsTable').html("");
						var tableRow;

						$
								.each(
										resp,
										function(i, client) {

											tableRow = "<tr>"
													+ "<td>"
													+ client.name
													+ "</td>"
													+ "<td><a href=\"javascript:editClient("
													+ client.clientID
													+ ")\">Edit</a>&nbsp;<a href=\"javascript:deleteClient("
													+ client.clientID
													+ ")\">Delete</a></td>"
													+ "</tr>";

											$('#clientsTable').append(tableRow);
										});
					},
					error : function(jqXHR, exception) {

						alert("Error Loading Clients");
						console.log(jqXHR.responseText);
					},
				       beforeSend : setHeader
				});
	}

	function editClient(id) {
		localStorage.client = id;
				document.location.href = "/StudentRest-HTML-JPA/WebContent/EditClient.html",
				true;

	}

	function deleteClient(id) {
		var txt;
		var r = confirm("Are you sure you want to delete the Client?");
		if (r == true) {
			txt = "Deleting Client!";
			//call to delete client service
			var url = "/SchoolRestJPA/rest/tabletopservices/clients/" + id;
			$.ajax({
				type : "DELETE",
				url : url,
				dataType : "json",
				contentType : "application/json; charset=utf-8",
				success : function(resp) {
					// we have the response  
					alert("Deleted Client");
					$('#clientsTable').html("");
					loadClientsTable();
				},
				error : function(jqXHR, exception) {
					alert("Error Deleting Client");
					console.log(jqXHR.responseText);

				},
			       beforeSend : setHeader
			});
			//reload clientsTable after delete
		} else {
			txt = "You pressed Cancel!";
		}
	}
</script>
</head>



<body>
	<!--  <script type="text/javascript">
$(document).ready(function() {
	$('#clientsNav').addClass('active');
})

</script>-->

   <div id="nav-container"></div>
	<div class="container">
		<div class="row">
			<h1>Clients</h1>
		</div>
		<div class="row">
			<a href="javascript:editClient(0)"
				class="btn btn-xs btn-primary pull-right"><i
				class="glyphicon glyphicon-plus"></i>New Client</a>
		</div>
		<hr>
		<div class="row">
		<div class="panel panel-primary"> 
  			<div class="panel-body">
			<table class="table table-striped table-hover ">
				<thead>
					<tr>

						<th>Client Name</th>
						<th>Actions</th>

					</tr>
				</thead>
				<tbody id="clientsTable">

				</tbody>
			</table>
		</div>
		</div>
		</div>

	</div>
	<script type="text/javascript">
    	$('#clientsNav').addClass('active');
    </script>
</body>
</html>