<!DOCTYPE html>

<html>
  <head>
    <title>Tabletops</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Bootstrap -->
<link href="css/bootstrap.css" rel="stylesheet" media="screen">
<link href="css/Site.css" rel="stylesheet" media="screen">
<link href="css/bootstrap-clockpicker.min.css" rel="stylesheet" >
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<script	src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>


<script src="js/bootstrap.min.js"></script>
<script src="js/bootstrap-clockpicker.min.js"></script>
<script src="js/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
     <script type="text/javascript">
		$(document).ready(function() {
			$('#nav-container').load('nav.html');
			loadGuestFromLocalStorage();
			loadGuestList();
			if(localStorage.editGuestId > 0)
			{
				loadWhiteList();
				loadBlackList();
			}
			
		});
	</script>
  </head>
  <body>
  <div id="nav-container">

  </div>
  <script type="text/javascript">
  function loadGuestFromLocalStorage(){
	  var id = localStorage.editGuestId;
		if(id > 0){
			var Url = "/SchoolRestJPA/rest/tabletopservices/guests/" + id;
			
		 	$.ajax({
		 		type: 'GET',
		 		url: Url,  
		 	    dataType: "json", 
		         success: function (data) {
		        	 //alert("success");
		        	 
		        	 $("#inputGuestId").val(id);
		        	 $("#inputName").val(data.name);
		         	 $("#inputRelationship").val(data.clientRelationship);
		         
		         },
		         error: function (jqXHR, exception) {
		    	    
		     	    console.log("Load Guest Error" + jqXHR.responseText);
		     	  }  
		     });
		}else{
			$("#whiteListPanel *").attr("disabled", "disabled");
			$("#blackListPanel *").attr("disabled", "disabled");
			$("#whiteListAdd").attr("disabled", true);
			$('#whiteListAdd').bind('click', false);
			
			$("#blackListAdd").attr("disabled", "disabled");
			$('#blackListAdd').bind('click', false);			
		}
  }
  $(document).ready(function() { 
	  $("#btnCancel").click(function(e){
		  //event should be set in local storage still. 
		  document.location.href = "/StudentRest-HTML-JPA/WebContent/EditEvent.html", true;
			
		}); 
  	$("#guestForm").submit(function(e){
	  e.preventDefault();
	  // Get form
      	var data = {};
    	var Form = this;
		
    	//Gathering the Data
    	//and removing undefined keys(buttons)
    	$.each(this.elements, function(i, v){
            var input = $(v);
        	data[input.attr("name")] = input.val();
        	console.log(input.attr("name") + " " + input.val());
        	delete data["undefined"];
    	});
		console.log(JSON.stringify(data));
      $("#btnSubmit").prop("disabled", true);
      
      
	  var guestID = $("#inputGuestId").val();
	  if(guestID > 0){
		  var url =  "/SchoolRestJPA/rest/tabletopservices/guests/" + guestID;	  
			$.ajax({
	          type: "PUT",
	          url: url,
	          contentType: "application/json; charset=utf-8",
	          dataType:"json",
	          data: JSON.stringify(data),          
	          cache: false,
	          context : Form,
	          success: function (data) {             
	              $("#btnSubmit").prop("disabled", false);
	              alert("Guest Data Saved");
	              //event id should still be in local storage
	        	  document.location.href = "/StudentRest-HTML-JPA/WebContent/EditEvent.html", true;
	          },
	          error: function (e) {
	        	  alert("Error Saving Guest Data");
	              console.log("ERROR : ", e.responseText);
	              
	              $("#btnSubmit").prop("disabled", false);
	          }
	      });
	  }else{ //new guest
		  var eventId = localStorage.event;
	  	  var eventobj = {};
	  	  eventobj["eventId"] = eventId;
	  		data["event"] = eventobj;
	  		console.log(JSON.stringify(data));
		  var url =  "/SchoolRestJPA/rest/tabletopservices/events/"+ eventId +"/guests";	  
			$.ajax({
	          type: "POST",
	          url: url,
	          contentType: "application/json; charset=utf-8",
	          dataType:"json",
	          data: JSON.stringify(data),          
	          cache: false,
	          context : Form,
	          success: function (data) {             
	              $("#btnSubmit").prop("disabled", false);
	              alert("Guest Data Saved");
	        	  document.location.href = "/StudentRest-HTML-JPA/WebContent/EditEvent.html", true;
	          },
	          error: function (e) {
	        	  alert("Error Saving Guest Data");
	        	  console.log("ERROR : ", e.responseText);
	              $("#btnSubmit").prop("disabled", false);
	          }
	      });
	  }
	  
	  
  	});
  });
  function loadGuestList(){
	  console.log("Loading Guests....");
	  id = localStorage.event;
	  if (id > 0){
		  $.ajax({ 
			   type: "GET",  
		       url: "/SchoolRestJPA/rest/tabletopservices/events/" + id + "/guests",  
		       dataType: "json",  
		       success: function(resp){  
		         // we have the response  
		         
		         $('#guestsTable').html("");
		      
		         var tableRow;
		             
		       
		        	 $("#selectWhiteListGuest").empty();
			         $("#selectWhiteListGuest").append("<option value='0'>---Select Guest---</option>");
			         $("#selectBlackListGuest").empty();
			         $("#selectBlackListGuest").append("<option value='0'>---Select Guest---</option>");
			         $.each(resp, function(i, guest){
			        	 $("#selectWhiteListGuest").append($("<option></option>").val(guest.guestId).html(guest.name));
			        	 $("#selectBlackListGuest").append($("<option></option>").val(guest.guestId).html(guest.name));
			         });
		        			        	       
		        	
		         
		       },  
		       error: function (jqXHR, exception) {
		    	    
		    	    console.log("Error" + jqXHR.responseText);
		    	  }  
			});
	  }
  }
  function loadBlackList(){
	  var id = localStorage.editGuestId;
	  $.ajax({ 
		   type: "GET",  
	       url: "/SchoolRestJPA/rest/tabletopservices/guests/" + id + "/blacklist",  
	       dataType: "json",  
	       success: function(resp){  
	         // we have the response  
	         
	         $('#blackListTable').html("");
	      
	         var tableRow;
	             
	         $.each(resp, function(i,guest){
	          //todo: date!!!
	        	
		    
	        	    tableRow = 
	        	        "<tr>"
	        	            +"<td>" + guest.name + "</td>"
	        	            +"<td><a href=\"javascript:deleteBlackListGuest(" + guest.guestId + ")\">Delete</a></td>"
	        	        +"</tr>";
	        	  console.log(tableRow);     
	        	$('#blackListTable').append(tableRow);
	         });
	       },  
	       error: function (jqXHR, exception) {
	    	    
	    	    alert("Error" + jqXHR.responseText);
	    	  }  
		});
  }
  function loadWhiteList(){
	  var id = localStorage.editGuestId;
	  $.ajax({ 
		   type: "GET",  
	       url: "/SchoolRestJPA/rest/tabletopservices/guests/" + id + "/whitelist",  
	       dataType: "json",  
	       success: function(resp){  
	         // we have the response  
	         
	         $('#whiteListTable').html("");
	      
	         var tableRow;
	             
	         $.each(resp, function(i,guest){
	          //todo: date!!!
	        	
		    
	        	    tableRow = 
	        	        "<tr>"
	        	            +"<td>" + guest.name + "</td>"
	        	            +"<td><a href=\"javascript:deleteWhiteListGuest(" + guest.guestId + ")\">Delete</a></td>"
	        	        +"</tr>";
	        	  console.log(tableRow);     
	        	$('#whiteListTable').append(tableRow);
	         });
	       },  
	       error: function (jqXHR, exception) {
	    	    
	    	    alert("Error" + jqXHR.responseText);
	    	  }  
		});
  }
  function addGuests(type){
	  var heading;
	  localStorage.ownerGuestId = localStorage.editGuestId;
	  var guestName =  $("#inputName").val();
	  var addguestval;
	  if(type == 0){
		  heading =  guestName + " White List";
	  	  addguestval = $("#selectWhiteListGuest").val();
	  	  console.log("addguestval " + addguestval);
	  	  url = "/SchoolRestJPA/rest/tabletopservices/guests/"+ localStorage.ownerGuestId + "/whitelist/"+ addguestval;
	  }
	  if(type == 1){
		  heading = guestName + " Black List";
		  addguestval = $("#selectBlackListGuest").val();
		  url = "/SchoolRestJPA/rest/tabletopservices/guests/"+ localStorage.ownerGuestId + "/blacklist/"+ addguestval;
	  }
	  //localStorage.editListTypeId = type;
	  //localStorage.editListTypeHeading = heading;
	  
	 
		$.ajax({
        type: "PUT",
        url: url,
        contentType: "application/json; charset=utf-8",
        dataType:"json",
//         data: JSON.stringify(data),          
        cache: false,
        //context : Form,
        success: function (data) {             
            $("#btnSubmit").prop("disabled", false);
            alert("Guest Data Saved");
            //event id should still be in local storage
      	  //document.location.href = "/StudentRest-HTML-JPA/WebContent/EditEvent.html", true;
        	 if(type == 0){
            	loadWhiteList();
        	 }else{
        		 loadBlackList();
        	 }
        },
        error: function (e) {
      	  alert("Error Saving Guest Data");
            console.log("ERROR : ", e.responseText);
          
        }
    });
	  
	 // document.location.href = "/StudentRest-HTML-JPA/WebContent/SelectAddGuests.html", true;  
  }
  
  function deleteWhiteListGuest(id){
	  localStorage.ownerGuestId = localStorage.editGuestId;
  }
  </script>
    <div class="container">


		<div class="row">
			<h1>Edit Guest</h1>
		</div>
		
		<div class="row">

			<form id="guestForm" class="form-horizontal">
				<div class="form-group">
				<input type="hidden" id="inputGuestId" name="guestId" value="">
					<label for="inputName" class="col-sm-2 col-md-2 col-lg-2 control-label">Name</label>
					<div class="col-sm-10 col-md-10 col-lg-10">
					 <input	type="text" class="form-control" name="name"  id="inputName" placeholder="Guest Name">
					</div>
				</div>
				<div class="form-group">
				
					<label for="inputComment" class="col-sm-2 col-md-2 col-lg-2 control-label">Client
						Relationship</label>
						
							<div class="col-sm-10 col-md-10 col-lg-10">
							 <input type="text" class="form-control" id="inputRelationship" name="clientRelationship" placeholder="Relationship to Client">
						</div>
				</div>
				<div class="btn-group pull-right">
					<div class="col-md-12 col-lg-12 ">
						<button type="submit" id="btnSubmit" class="btn btn-primary">Submit</button>
						<button type="reset" id="btnCancel" class="btn btn-default">Cancel</button>
					</div>
				</div>
			</form>
		</div>
	<hr />
	<!-- End of Guest form       -->

		<div class="row">
			<div id="whiteListPanel" class="panel panel-primary">
				<div class="panel-heading clearfix">
					<div class="pull-right">
						<div class="form-inline">
								<select class="form-control" id="selectWhiteListGuest" name="EventTime">
								</select>
								<a href="javascript:addGuests(0)" id="whiteListAdd" class="btn btn-primary"><i class="glyphicon glyphicon-plus"></i>Add Guest</a>
								
							
						</div>
					</div>
					<h3 class="panel-title">White List</h3>

				</div>
				<div class="panel-body">
					<table id="whiteListTable" class="table table-striped table-hover ">
						<thead>
							<tr>
								<th>Guest</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody id="whiteListTable">

						</tbody>
					</table>

				</div>
			</div>
		</div>

		<div class="row">
			<div id="blackListPanel" class="panel panel-primary">
				<div class="panel-heading clearfix">
					<div class="pull-right">
						<div class="form-inline">
							<div class="form-inline">
							<select class="form-control form-control-sm" id="selectBlackListGuest" name="blacklist"></select>
								<a href="javascript:addGuests(1)" id="blackListAdd" class="btn btn-primary"><i class="glyphicon glyphicon-plus"></i>Add Guest</a>
							</div>
						</div>
					</div>
					<h3 class="panel-title">Black List</h3>
				</div>
				<div class="panel-body">
					<table class="table table-striped table-hover ">
						<thead>
							<tr>
								<th>Guest</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody id="blackListTable">
						</tbody>
					</table>

				</div>
			</div>
		</div>


	</div><!-- /.container -->
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
  </body>
</html>