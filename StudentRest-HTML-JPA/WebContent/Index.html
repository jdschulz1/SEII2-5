<!DOCTYPE html>
<html>
<head>
<title>Tabletops</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap -->
<link href="css/bootstrap.css" rel="stylesheet" media="screen">
<link href="css/Site.css" rel="stylesheet" media="screen">
<link rel="stylesheet"
	href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script type="text/javascript"
	src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

<script type="text/javascript">
	$(document).ready(function() {
		$('#nav-container').load('nav.html');
		loadClientListDropDown();
		loadMyEvents();
	});
</script>

</head>
<body>
	<script type="text/javascript">
		function getCookie(cname) {
			console.log("get cookie");
			var name = cname + "=";
			var decodedCookie = decodeURIComponent(document.cookie);
			var ca = decodedCookie.split(';');
			for (var i = 0; i < ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0) == ' ') {
					c = c.substring(1);
				}
				if (c.indexOf(name) == 0) {
					return c.substring(name.length, c.length);
				}
			}
			return "";
		}

		function setHeader(xhr) {
			console.log("set Header");
			token = getCookie("token");
			console.log("Token: " + token);
			xhr.setRequestHeader('Authorization', 'Bearer ' + token);
		}

		function loadMyEvents(callback) {
			console.log("Loading Events....");

			if(getCookie("token") != null) {
				var token = getCookie("token");
				var url = "/SchoolRestJPA/rest/tabletopservices/events/tokens/"+token;
			}
			else {
				var url = "/SchoolRestJPA/rest/tabletopservices/events";
			}

			$
					.ajax({
						type : "GET",
						url : url,
						cache : false,
						dataType : "json",
						statusCode : {
							401 : function(response) {
								$('#page-message').html("You must Login first");
								alert("Please login to access this page");
					        	document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
							},
							405 : function(response) {
								$('#page-message').html(
										"Access to the page forbidden");
								alert("Please login to access this page");
								document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
							}
						},
						success : function(resp) {
							// we have the response  

							$('#eventTable').html("");

							var tableRow;

							$
									.each(
											resp,
											function(i, event) {
												//todo: date!!!
												var month;
												var day;

												if (event.eventDateTime.monthValue < 10) {
													month = "0"
															+ event.eventDateTime.monthValue;
												} else {
													month = event.eventDateTime.monthValue;
												}

												if (event.eventDateTime.dayOfMonth < 10) {
													day = "0"
															+ event.eventDateTime.dayOfMonth;
												} else {
													day = event.eventDateTime.dayOfMonth;
												}
												var minute;
												if (event.eventDateTime.minute < 10) {
													minute = "0"
															+ String(event.eventDateTime.minute);
												} else {
													minute = event.eventDateTime.minute;
												}

												var hour;
												if (event.eventDateTime.hour < 10) {
													hour = "0"
															+ String(event.eventDateTime.hour);
												} else {
													hour = event.eventDateTime.hour;
												}
												var theEventDate = month
														+ "-"
														+ day
														+ "-"
														+ event.eventDateTime.year;
												var theEventTime = hour + ":"
														+ minute;
												tableRow = "<tr>"
														+ "<td>"
														+ event.eventTitle
														+ "</td>"
														+ "<td>"
														+ theEventDate
														+ "</td>"
														+ "<td>"
														+ theEventTime
														+ "</td>"
														+ "<td>"
														+ event.venueName
														+ "</td>"
														+ "<td><a href=\"javascript:editEvent("
														+ event.eventId
														+ ")\">Edit</a>&nbsp;<a href=\"javascript:deleteEvent("
														+ event.eventId
														+ ")\">Delete</a></td>"
														+ "</tr>";
												console.log(JSON.stringify(event.eventTitle));
												$('#eventTable').append(
														tableRow);
											});
						},
						error : function(jqXHR, exception) {
						//	alert("Error" + jqXHR.responseText);
						},
						beforeSend : setHeader
					});
		}

		function searchEvent() {
			//Get id of selected client
			//get date
			if (document.getElementById("selectClient").value != 0
					&& document.getElementById("eventDate").value) {
				console.log("Loading Events with Client and Date....");
				var dd = $("#eventDate").datepicker("getDate").getDate();
				var mm = $("#eventDate").datepicker("getDate").getMonth() + 1;//new Date(sdate).getMonth()+1;
				var yy = $("#eventDate").datepicker("getDate").getFullYear();//new Date(sdate).getFullYear();
				var hh = 00;
				var ms = 00;
				var x = yy + ',' + mm + ',' + dd + ' ' + hh + ':' + ms;
				var eventDateTime = new Date(x);
				var stupidFuckingDateString = new Date(eventDateTime.getTime()
						- (eventDateTime.getTimezoneOffset() * 60000)).toJSON(); //2017-07-03T00:10:00.000Z
				var finalStupidFuckingDateString = stupidFuckingDateString
						.split(".")[0];

				var url = "/SchoolRestJPA/rest/tabletopservices/events;client="
						+ document.getElementById("selectClient").value
						+ ";date=" + finalStupidFuckingDateString;
			} else if (document.getElementById("selectClient").value != 0
					&& !document.getElementById("eventDate").value) {
				console.log("Loading Events with Client!....");

				var url = "/SchoolRestJPA/rest/tabletopservices/events;client="
						+ document.getElementById("selectClient").value;
			} else if (document.getElementById("selectClient").value == 0
					&& document.getElementById("eventDate").value) {
				console.log("Loading Events with Date....");
				var dd = $("#eventDate").datepicker("getDate").getDate();
				var mm = $("#eventDate").datepicker("getDate").getMonth() + 1;//new Date(sdate).getMonth()+1;
				var yy = $("#eventDate").datepicker("getDate").getFullYear();//new Date(sdate).getFullYear();
				var hh = 00;
				var ms = 00;
				var x = yy + ',' + mm + ',' + dd + ' ' + hh + ':' + ms;
				var eventDateTime = new Date(x);
				var stupidFuckingDateString = new Date(eventDateTime.getTime()
						- (eventDateTime.getTimezoneOffset() * 60000)).toJSON(); //2017-07-03T00:10:00.000Z
				var finalStupidFuckingDateString = stupidFuckingDateString
						.split(".")[0];
				var url = "/SchoolRestJPA/rest/tabletopservices/events;date="
						+ finalStupidFuckingDateString;
			} else {
				var url = "/SchoolRestJPA/rest/tabletopservices/events";
			}
			console.log(document.getElementById("selectClient").value + " AND "
					+ document.getElementById("eventDate").value);
			$
					.ajax({
						type : "GET",
						url : url,
						cache : false,
						dataType : "json",
						success : function(resp) {
							// we have the response  

							$('#eventTable').html("");

							var tableRow;

							$
									.each(
											resp,
											function(i, event) {
												//todo: date!!!
												var month;
												var day;

												if (event.eventDateTime.monthValue < 10) {
													month = "0"
															+ event.eventDateTime.monthValue;
												} else {
													month = event.eventDateTime.monthValue;
												}

												if (event.eventDateTime.dayOfMonth < 10) {
													day = "0"
															+ event.eventDateTime.dayOfMonth;
												} else {
													day = event.eventDateTime.dayOfMonth;
												}
												var minute;
												if (event.eventDateTime.minute < 10) {
													minute = "0"
															+ String(event.eventDateTime.minute);
												} else {
													minute = event.eventDateTime.minute;
												}

												var hour;
												if (event.eventDateTime.hour < 10) {
													hour = "0"
															+ String(event.eventDateTime.hour);
												} else {
													hour = event.eventDateTime.hour;
												}
												var theEventDate = month
														+ "-"
														+ day
														+ "-"
														+ event.eventDateTime.year;
												var theEventTime = hour + ":"
														+ minute;
												tableRow = "<tr>"
														+ "<td>"
														+ event.eventTitle
														+ "</td>"
														+ "<td>"
														+ theEventDate
														+ "</td>"
														+ "<td>"
														+ theEventTime
														+ "</td>"
														+ "<td>"
														+ event.venueName
														+ "</td>"
														+ "<td><a href=\"javascript:editEvent("
														+ event.eventId
														+ ")\">Edit</a>&nbsp;<a href=\"javascript:deleteEvent("
														+ event.eventId
														+ ")\">Delete</a></td>"
														+ "</tr>";

												$('#eventTable').append(
														tableRow);
											});
						},
						error : function(jqXHR, exception) {

							alert("Error" + jqXHR.responseText);
						},
						beforeSend : setHeader
					});

		}

		function editEvent(id) {
			localStorage.event = id;
					document.location.href = "/StudentRest-HTML-JPA/WebContent/EditEvent.html",
					true;
		}

		function deleteEvent(id) {
			var txt;
			var r = confirm("Are you sure you want to delete the Event?");
			if (r == true) {
				txt = "Deleting Event!";
				var url = "/SchoolRestJPA/rest/tabletopservices/events/" + id;
				$.ajax({
					type : "DELETE",
					url : url,
					dataType : "json",
					contentType : "application/json; charset=utf-8",
					success : function(resp) {
						// we have the response  
						alert("Event Deleted");
						loadMyEvents();
					},
					error : function(jqXHR, exception) {
						alert("Error Deleting Event");
						console.log(jqXHR.responseText);

					},
					beforeSend : setHeader
				});
			} else {
				txt = "You pressed Cancel!";
			}
		}

		function search(date, client) {
			$(document).ready(function() {
				//$("#editClientForm").submit(function(e){
				var eventDate = $("#eventDate").val();

				//});
			});
		}

		function loadClientListDropDown() {
			$.ajax({
				type : "GET",
				url : "/SchoolRestJPA/rest/tabletopservices/clients",
				dataType : "json",
				success : function(resp) {

					$("#selectClient").empty();
					$("#selectClient").append(
							"<option value='0'>---Select Client---</option>");
					$.each(resp, function(i, client) {
						console.log(client);
						$("#selectClient").append(
								$("<option></option>").val(client.clientID)
										.html(client.name));
					});
				},
				error : function(jqXHR, exception) {

					console.log(jqXHR.responseText);
				},
				beforeSend : setHeader
			});
		}
	</script>
	<div id="nav-container"></div>

	<div id="#content" class="container">
		<div class="row">
			<div class="form-inline">
				<form>
					<div class="pull-right">
						<input type="datetime" id="eventDate"
							class="form-control input-sm date-input" maxlength="64"
							placeholder="Event Date" /> <select
							class="form-control input-sm" id="selectClient">
							<option>Select Client</option>
						</select>

						<button type="button" id="btnSearch"
							class="btn btn-primary btn-sm" onclick="searchEvent()">Search</button>
					</div>
				</form>
			</div>

		</div>
		<hr />
		<div class="row">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">My Events</h3>
				</div>
				<div class="panel-body">
					<div class="row">

						<a href="javascript:editEvent(0)"
							class="btn btn-xs btn-primary pull-right"><i
							class="glyphicon glyphicon-plus"></i>New Event</a>

					</div>
					<hr>
					<div class="row">
						<table class="table table-striped table-hover ">
							<thead>
								<tr>
									<th>Title</th>
									<th>Date</th>
									<th>Time</th>
									<th>Venue</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody id="eventTable">

							</tbody>
						</table>
					</div>
				</div>
			</div>

		</div>
	</div>
	<div class="row" id="searchResults"></div>
	<script type="text/javascript">
		$(".date-input").datepicker();
	</script>
</body>

</html>
