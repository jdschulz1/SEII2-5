<!DOCTYPE html>
<html>
<head>
<title>Tabletops</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap -->
<link href="css/bootstrap.css" rel="stylesheet" media="all">
<link href="css/Site.css" rel="stylesheet" media="all">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script type="text/javascript">
	$(document).ready(function() {
		$('#nav-container').load('nav.html');
		localStorage.tablesNavSelect = "btnEditSeatingArrangement";
		$('#tables-nav').load('TablesNav.html');
		loadUsersTable();
	});
</script>
</head>
<body>
	<script type="text/javascript">
	$(document).ready(function() {
		$('#title').html("Edit Seating Arrangement - " + localStorage.clientName + " - "+ localStorage.venueName);
	});
		function getCookie(cname) {
			console.log("get cookie");
			var name = cname + "=";
			var decodedCookie = decodeURIComponent(document.cookie);
			var ca = decodedCookie.split(';');
			for (var i = 0; i < ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0) == ' ') {
					c = c.substring(1);
				}
				if (c.indexOf(name) == 0) {
					return c.substring(name.length, c.length);
				}
			}
			return "";
		}
		
		function setHeader(xhr) {
			console.log("set Header");
			token = getCookie("token");
			console.log("Token: " + token);
			xhr.setRequestHeader('Authorization', 'Bearer ' + token);
		}
		function loadUsersTable() {
			var hasSeatingArrangment = true;
			var id = localStorage.eventId;
			if (id > 0) {
				var guestsUrl = "/SchoolRestJPA/rest/tabletopservices/events/"
						+ id + "/guests";

				$
						.ajax({
							type : "GET",
							url : guestsUrl,
							dataType : "json",
							statusCode : {
								401 : function(response) {
									$('#page-message').html("You must Login first");
									alert("Please login to access this page");
						        	document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
								},
								405 : function(response) {
									$('#page-message').html(
											"Access to the page forbiden");
									alert("Please login to access this page");
									document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
								}
							},
							success : function(resp) {
								// we have the response  

								$('#guest_tables').html('');

								var guests = [];
								var tableNums = [];
								
								var listTablesWithId = [];
								$
										.each(
												resp,
												function(i, guest) {
													if(guest.guestFitness == null){
														console.log("Guest fitness null");
														hasSeatingArrangment = false;
														$('#guest_tables').html("<h1>No Seating Arrangment has been generated</h1");
														return false;
									        	 }
													if (guest.eventTableNumber == null) {
														alert("No table for guest "
																+ guest.name);
													} else {
														if (guests[guest.eventTableNumber] == null) {
															guests[guest.eventTableNumber] = [];
															tableNums
																	.push(guest.eventTableNumber);
															listTablesWithId.push({id : guest.eventTableId, number : guest.eventTableNumber});
														}
														guests[guest.eventTableNumber]
																.push(guest);
													}
												});
								if(hasSeatingArrangment)
								{
									tableNums.sort();
									
									listTablesWithId = listTablesWithId.sort(function (a, b) {
									    return a.number.localeCompare( b.number );
									});
									var table;
									var selectTableNums = "<select>";
									selectTableNums += "<option value=\"0\"></option>";
									$.each( listTablesWithId, function( index, value ){
										selectTableNums  += "<option value=\""+ value.id +"\">" + value.number + "</option>";	
									});
									selectTableNums += "</select>";
									for (var i = 0; i < tableNums.length; i++) {
										var key = tableNums[i];
										var table = '<div class="panel panel-primary">'
												+ '<div class="panel-heading">'
												+ '<h3 class="panel-title">Table '
												+ key
												+ '</h3></div>'
												+ '<div class="panel-body">'
												+ '<div class="row"><table class="table table-striped table-hover">'
												+ '<thead><tr><th class=\"col-sm-6 col-md-6 col-lg-6\">Guest Name</th><th class=\"col-sm-6 col-md-6 col-lg-6\">Move to Table</th></tr></thead><tbody>';
										var tableGuests = guests[key];
										for (var j = 0; j < tableGuests.length; j++) {
											guest = tableGuests[j];
											console.log(guest);
											table = table + "<tr>" 
													+ "<td class=\"col-sm-6 col-md-6 col-lg-6\">" + guest.name + "</td>"
													+"<td class=\"col-sm-6 col-md-6 col-lg-6\">"+ selectTableNums +"<a href=\"#\" onclick=\"moveGuest(this," + guest.guestId + ")\">Move</a></td></tr>";
										}
										table = table
												+ '</tbody></div></div></table></div>';
										$('#guest_tables').append(table);
									}
								}
								
							},
							error : function(jqXHR, exception) {

								alert(jqXHR.responseText);
							},
						       beforeSend : setHeader
						});
			}
		}
	
		function moveGuest(caller, guestId){
			  var newTableId = $(caller).prev('select').val();
			  console.log("TableID " + newTableId);
			  var url = "/SchoolRestJPA/rest/tabletopservices/guests/" + guestId + "/moveToTable/" + newTableId;
			  $.ajax({
		          type: "PUT",
		          url: url,
		          contentType: "application/json; charset=utf-8",
		          dataType:"json",
		          statusCode : {
						403 : function(response) {
							$('#page-message').html("Access Denied");
							alert("You must login to perform this action");
						},
						412 : function(response) {
							$('#page-message').html("Precondition Failed");
							alert("Guest cannot move");
		          		}
					},
		          //data: JSON.stringify(data),          
		          cache: false,
		         // context : Form,
		          success: function (data, textStatus, xhr) {
		        	  $('#successMessages').fadeIn().html(data);
		        	  setTimeout(function() {
							$('#successMessages').fadeOut("slow");
						}, 2000 );
		        	  console.log("textStatus --" + textStatus);
		        	  console.log("THE STATUS-----" + xhr.status);
		        	  console.log(xhr.responseText);
		        	
		        	  loadUsersTable();
		          },
		          error: function (e) {
		              console.log("ERROR : ", e.responseText);
		              alert("There was an error moving the guest.");
		              loadUsersTable();
		          },
			       beforeSend : setHeader
		      });			  
				
		}
		
		
	</script>
	<div id="nav-container"></div>

	<div class="container">

		<div class="col-sm-12 col-md-12 col-lg-12">
			<h2 id="title">Edit Seating Arrangement </h2>
			<div id="tables-nav"></div>
			<div class="container">
				<div class="row">
					<h3>Guests</h3>
					<button class="btn btn-xs btn-default pull-right" onclick="window.print();">Print</button>
				</div>
				<hr />
				<div class="row" id="guest_tables"></div>
			</div>
		</div>
	</div>
</body>
</html>