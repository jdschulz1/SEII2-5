<!DOCTYPE html>
<html>
  <head>
      <title>Tabletops</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="css/bootstrap.css" rel="stylesheet" media="screen">
    <link href="css/Site.css" rel="stylesheet" media="screen">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			 $('#nav-container').load('nav.html'); 
			loadUsersTable();
		});
	</script>
  </head>
  <body>
  <script type="text/javascript">
  function getCookie(cname) {
		console.log("get cookie");
		var name = cname + "=";
		var decodedCookie = decodeURIComponent(document.cookie);
		var ca = decodedCookie.split(';');
		for (var i = 0; i < ca.length; i++) {
			var c = ca[i];
			while (c.charAt(0) == ' ') {
				c = c.substring(1);
			}
			if (c.indexOf(name) == 0) {
				return c.substring(name.length, c.length);
			}
		}
		return "";
	}

	function setHeader(xhr) {
		console.log("set Header");
		token = getCookie("token");
		console.log("Token: " + token);
		xhr.setRequestHeader('Authorization', 'Bearer ' + token);
	}
  function loadUsersTable(){
		 $.ajax({ 
			   type: "GET",  
		       url: "/SchoolRestJPA/rest/tabletopservices/users",  
		       dataType: "json",
		       statusCode : {
					401 : function(response) {
						$('#page-message').html("You must Login first");
						alert("Please login to access this page");
			        	document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
					},
					405 : function(response) {
						$('#page-message').html(
								"Access to the page forbiden");
						alert("Please login to access this page");
						document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
					}
				},
		       success: function(resp){  
		         // we have the response  
		       
		         $('#usersTable').html("");
		         var tableRow;
	  
		         $.each(resp, function(i, user){
		        		
		        	    tableRow = 
		        	        "<tr>"
		        	            +"<td>" + user.name + "</td>"
		        	            +"<td>" + user.userName + "</td>"
		        	            +"<td>" + user.email + "</td>"
								+"<td><a href=\"javascript:editUser(" + user.userID + ")\">Edit</a>&nbsp;<a href=\"javascript:deleteUser(" + user.userID + ")\">Delete</a></td>"
		        	        +"</tr>";
		        	       
		        	$('#usersTable').append(tableRow);
		         });
		       },  
		       error: function (jqXHR, exception) {
		    	    
		    	    console.log("Error" + jqXHR.responseText);
		    	    console.log(exception.responseText);
		    	  },
			       beforeSend : setHeader  
			});
	}

	function editUser(id){
		localStorage.user = id;
		document.location.href = "/StudentRest-HTML-JPA/WebContent/UserEdit.html", true;  
		
	}

	function deleteUser(id){
		var txt;
		var r = confirm("Are you sure you want to delete the user?");
		if (r == true) {
		    txt = "Deleting User!";
		  //call to delete user service
			var url = "/SchoolRestJPA/rest/tabletopservices/users/" + id;
			$.ajax({ 
				   type: "DELETE",  
			       url: url,  
			       dataType: "json",
			       statusCode : {
						403 : function(response) {
							$('#page-message').html("Access Denied");
							alert("You must have admin credentials to perform this action");
						},
		          },
			       contentType: "application/json; charset=utf-8",
			       success: function(resp){  
			         // we have the response  
			       
			         alert("User Deleted");
			         loadUsersTable();
			       },  
			       error: function (jqXHR, exception) {
			    	    console.log(jqXHR.responseText);
			   			alert("Error Deleting User");
			    	  },
				       beforeSend : setHeader  
				});
		
		} else {
		    txt = "You pressed Cancel!";
		}
		
		
	}
  </script>
   <div id="nav-container">

  </div>

    <div class="container">

     
      <div class="row"> 
     <h1>Users</h1> 
        </div>
        <div class="row">
          
        	<a href="javascript:editUser(0)" class="btn btn-xs btn-primary pull-right"><i class="glyphicon glyphicon-plus"></i>New User</a>
        
        </div>
        <div class="row">
        <table class="table table-striped table-hover ">
  <thead>
    <tr>
      <th>Name</th>
      <th>Username</th>
      <th>Email</th>
      <th>Actions</th>
      
    </tr>
  </thead>
  <tbody id="usersTable">
    
      </tbody>
</table>
</div>
     

    </div><!-- /.container -->
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
  </body>

</html>