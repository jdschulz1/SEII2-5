<!DOCTYPE html>
<html>
  <head>
    <title>Tabletops</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap -->
<link href="css/bootstrap.css" rel="stylesheet" media="screen">
<link href="css/Site.css" rel="stylesheet">
<link href="css/bootstrap-clockpicker.min.css" rel="stylesheet" >
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
 <script src="js/jquery-3.2.1.min.js"></script>
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  
<!-- <script	src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script> -->

<script src="js/bootstrap.min.js"></script>
<script src="js/bootstrap-clockpicker.min.js"></script>
<script src="js/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
<script src="js/jquery.twbsPagination.min.js"></script>


</head>
  <body>
  <script type="text/javascript">
	$(document).ready(function() {
		$('#nav-container').load('nav.html');
		var eventobj;
		
		loadEventFromLocalStorage();
		loadGuests();
	});
</script>

<script type="text/javascript">
function getCookie(cname) {
	console.log("get cookie");
	var name = cname + "=";
	var decodedCookie = decodeURIComponent(document.cookie);
	var ca = decodedCookie.split(';');
	for (var i = 0; i < ca.length; i++) {
		var c = ca[i];
		while (c.charAt(0) == ' ') {
			c = c.substring(1);
		}
		if (c.indexOf(name) == 0) {
			return c.substring(name.length, c.length);
		}
	}
	return "";
}

function setHeader(xhr) {
	console.log("set Header");
	token = getCookie("token");
	console.log("Token: " + token);
	xhr.setRequestHeader('Authorization', 'Bearer ' + token);
}
  function loadEventFromLocalStorage(){
	  loadPlanners();
	  loadClients();	
	  var id = localStorage.event;
		if(id > 0){
			
			var clientUrl = "/SchoolRestJPA/rest/tabletopservices/events/" + id;
			console.log('----------------------------Loading event....');
		 	$.ajax({
		 		type: 'GET',
		 		url: clientUrl,  
		 	    dataType: 'json',
		 	   statusCode : {
					401 : function(response) {
						$('#page-message').html("You must Login first");
						alert("Please login to access this page");
			        	document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
					},
					405 : function(response) {
						$('#page-message').html(
								"Access to the page forbiden");
						alert("Please login to access this page");
						document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
					}
				},
		        success: function (data) {
		        	
		        	 eventobj = data;
		        	 console.log("load even success")
		        	$('#inputEventID').val(id);
		        	$("#inputTitle").val(data.eventTitle);
 		         	
 		         	$('#inputRole').val(data.role);
 		         	$('#inputVenueName').val(data.venueName);
 		         	var month;
 		         	var day;
 		         	
 		         	if (data.eventDateTime.monthValue < 10){
 		         		month = "0" + data.eventDateTime.monthValue;
 		         	}else{
 		         		month = data.eventDateTime.monthValue;
 		         	}
 		         	
 		         	if(data.eventDateTime.dayOfMonth < 10){
 		         		day = "0" + data.eventDateTime.dayOfMonth;
 		         	}else{
 		         		day = data.eventDateTime.dayOfMonth;
 		         	}
 		         	
 		         	$('#inputEventDate').val(month +"/"+ day +"/"+data.eventDateTime.year);
 		         	
 		         	var minute;
 		         	if (data.eventDateTime.minute < 10){
 		         		minute = "0" + String(data.eventDateTime.minute);
 		         	}else{
 		         		minute = data.eventDateTime.minute;
 		         	}
 		         	
 		         	var hour;
 		         	if (data.eventDateTime.hour < 10){
 		         		hour = "0" + String(data.eventDateTime.hour);
 		         	}else{
 		         		hour = data.eventDateTime.hour;
 		         	}
 		         	
 		         	$("#inputEventTime").val(hour + ":" + minute);
 		         	$("#inputTableEmptySpots").val(data.maxEmptySeats);
 		         	console.log(data.primaryPlanner.userID);
 		         	console.log(data.primaryPlanner.name);
 		         	$("#selectPrimaryPlanner").val(data.primaryPlanner.userID).change();
 		         	$("#inputTableSize").val(data.eventTableSize);
 		         	
 		         		$("#selectClientName").val(data.client.clientID).change();	
 	
 		         	
		         },
		         error: function (jqXHR, exception) {
		    	    console.log('Load Event ERROR' + jqXHR.responseText);
		     	   
		     	  },
			       beforeSend : setHeader  
		     });
		}else{
			
			$("#guestsPanel").addClass("disableDiv");
			$("#guestsPanel *").attr("disabled", "disabled");
			$("#btnNewGuest").attr("disabled", true);
			$('#btnNewGuest').bind('click', false);
			
			$("#btnSeatingArrangement").attr("disabled", "disabled");
			$('#btnSeatingArrangement').bind('click', false);
		}
  }
	  
  $(document).ready(function() {
	 $("#btnCancel").click(function(e){
		document.location.href = "/StudentRest-HTML-JPA/WebContent/Index.html", true;
	});
  	$("#editEventForm").submit(function(e){
	  e.preventDefault();

     	var Form = this;

    //get selected client	
    var client = {};
    client["clientId"] = $("#selectClientName").val();
   
    var event1 = {};
    
    //get selected date and time
    //var sdate = $("#inputEventDate").datepicker('getDate');
    var stime = $("#inputEventTime").val();
    console.log("TIME ---" + stime);
    var dd = $("#inputEventDate").datepicker("getDate").getDate();
    var mm = $("#inputEventDate").datepicker("getDate").getMonth();//new Date(sdate).getMonth()+1;
    var yy = $("#inputEventDate").datepicker("getDate").getFullYear();//new Date(sdate).getFullYear();
    var hh = stime.split(":")[0];
    console.log("Hour ---" + hh);
    var ms = stime.split(":")[1];
    
    var x = yy + ',' + mm + ',' + dd + ' ' + hh + ':' + ms ;
    var eventDateTime = new Date(x);
    console.log("x " + x);
    console.log("DateTime" + eventDateTime);
    var stupidFuckingDateString = new Date(eventDateTime.getTime()  - (eventDateTime.getTimezoneOffset() * 60000)).toJSON(); //2017-07-03T00:10:00.000Z
    var finalStupidFuckingDateString = stupidFuckingDateString.split(".")[0];
    console.log(stupidFuckingDateString + "---------------------" + finalStupidFuckingDateString);
    
    var primaryPlanner = {};
    primaryPlanner["userId"] = $("#selectPrimaryPlanner").val();
   

    event1["client"] = client;
    event1["eventDateTime"] = finalStupidFuckingDateString;//"2007-12-03T10:15:30";
    
    
    event1["eventTableSize"] = $("#inputTableSize").val();
    event1["eventTitle"] = $("#inputTitle").val();
    event1["maxEmptySeats"] = $("#inputTableEmptySpots").val();
   
    event1["primaryPlanner"] = primaryPlanner;
    event1["venueName"] = $("#inputVenueName").val();
    
      $("#btnSubmit").prop("disabled", true);
      
      
	  var eventID = $("#inputEventID").val();
	 
	  if(eventID > 0){
		  console.log(JSON.stringify(eventobj.guestList));
		 // event1["guestList"] = eventobj.guestList;
		  event1["eventId"] = eventobj.eventId;
		  //event1["guestList"] = eventobj.guestList;
		   console.log(JSON.stringify(event1));
		  var url =  "/SchoolRestJPA/rest/tabletopservices/events/" + eventID;	  
			$.ajax({
	          type: "PUT",
	          url: url,
	          dataType:"json",
	          contentType: "application/json; charset=utf-8",
	          data: JSON.stringify(event1),          
	          cache: false,
	         // context : Form,
	          success: function (data) {             
	              $("#btnSubmit").prop("disabled", false);
	              alert("Event Data has been saved.");
	          },
	          error: function (e) {
	        	  alert("Error Saving Event");
	              console.log("ERROR : ", e.responseText);
	              $("#btnSubmit").prop("disabled", false);
	          },
		       beforeSend : setHeader
	      });
	  }else{ //new event
		  event1["guestList"] = [];
		  console.log(JSON.stringify(event1));
		  var url =  "/SchoolRestJPA/rest/tabletopservices/events";	  
			$.ajax({
	          type: "POST",
	          url: url,
	          contentType: "application/json; charset=utf-8",
	          dataType:"json",
	          data: JSON.stringify(event1),          
	          cache: false,
	          //context : Form,
	          success: function (data) {   
	        	  alert("Event Data has been saved.");
	        	  $("#guestsPanel").removeClass("disableDiv");
	              $("#btnSubmit").prop("disabled", false);
	              $("#guestsPanel *").attr("disabled", false);
	  			$("#btnNewGuest").attr("disabled", false);
	  			$('#btnNewGuest').unbind('click', false);
	  			
	  			$("#btnSeatingArrangement").attr("disabled", false);
	  			$('#btnSeatingArrangement').unbind('click', false);
	          },
	          error: function (e) {
	        	  alert("Error Saving Event");
	              console.log("ERROR : ", e.responseText);
	              $("#btnSubmit").prop("disabled", false);
	          },
		       beforeSend : setHeader
	      });
	  }
	  
	  
  	});
  });
  function seatingArrangement(){
		localStorage.eventId = localStorage.event;
		localStorage.clientName = eventobj.client.name;
		localStorage.venueName = eventobj.venueName;
		document.location.href = "/StudentRest-HTML-JPA/WebContent/PrintTablesList.html", true;  
		
	}
function loadPlanners(){
	  console.log("Loading planners...");
// 	  $("select").change(function(){
// 		    alert($(this).find(":selected").data("value").age);
// 		});
		var Url = "/SchoolRestJPA/rest/tabletopservices/users"
	  $.ajax({
	 		type: 'GET',
	 		url: Url,  
	 	    dataType: "json", 
	         success: function (data) {
	        	 //alert("success");
	        	 
	        	 $("#selectPrimaryPlanner").empty();
		         $("#selectPrimaryPlanner").append("<option value='0'>---Select Primary Planner---</option>");
		         $.each(data, function(i, user){
		        	 $("#selectPrimaryPlanner").append($("<option></option>").val(user.userID).html(user.name));
		         });
	        	
	         },
	         error: function (jqXHR, exception) {
	    	    
	     	    alert("Load Client Error" + jqXHR.responseText);
	     	  },
		       beforeSend : setHeader  
	     });
  		console.log("loading planners");
  }
  
  function loadClients(){
	  	console.log("Loading Clients....");
		var Url = "/SchoolRestJPA/rest/tabletopservices/clients"
			  $.ajax({
			 		type: 'GET',
			 		url: Url,  
			 	    dataType: "json", 
			         success: function (data) {
			        	 //alert("success");
			        	 
			        	 $("#selectClientName").empty();
				         $("#selectClientName").append("<option value='0'>---Select Client---</option>");
				         $.each(data, function(i, client){
				        	 $("#selectClientName").append($("<option></option>").val(client.clientID).html(client.name));
				         });
			        	
			         },
			         error: function (jqXHR, exception) {
			    	    
			     	    alert("Load Client Error" + jqXHR.responseText);
			     	  },
				       beforeSend : setHeader  
			     });
  }
  
  function loadGuests(){
	 
	console.log("Loading Guests....Event ID = " + localStorage.event);
		id = localStorage.event;
// 		$('#pagination').twbsPagination(
// 						{
// 							totalPages : 5,
// 							visiblePages : 5,
// 							next : 'Next',
// 							prev : 'Prev',
// 							onPageClick : function(event, page) {
// 								//fetch content and render here
								var table = "";
								if (id > 0) {
									$.ajax({
										type : "GET",
										url : "/SchoolRestJPA/rest/tabletopservices/events/" + id + "/guests",
												dataType : "json",
// 												data : {
// 													page : page,
// 													per_page : "15"	},
												success : function(resp) {
													// we have the response  

													$('#guestsTable').html("");

													var tableRow;

													$.each(resp,function(i, guest) {

																		tableRow = "<tr>"
																				+ "<td>"
																				+ guest.name
																				+ "</td>"
																				+ "<td>"
																				+ guest.clientRelationship
																				+ "</td>"
																				+ "<td><a href=\"javascript:editGuest("
																				+ guest.guestId
																				+ ")\">Edit</a>&nbsp;<a href=\"javascript:deleteGuest("
																				+ guest.guestId
																				+ ")\">Delete</a></td>"
																				+ "</tr>";

																		//$('#guestsTable').append(tableRow);
																		table += (tableRow);

																	});
													//console.log("table " + (String(table)));
													$("#guestsTable").html(table);
												},
												error : function(jqXHR,exception) {

													console.log("Error"	+ jqXHR.responseText);
												},
											       beforeSend : setHeader
											});
								//}
								
								
							}
						//});

	}

	function deleteGuest(guestId) {
		var txt;
		id = localStorage.event;
		var r = confirm("Are you sure you want to delete the Guest?");
		if (r == true) {
			txt = "Deleting Guest!";
			var url = "/SchoolRestJPA/rest/tabletopservices/guests/" + guestId;
			$.ajax({
				type : "DELETE",
				url : url,
				dataType : "json",
				contentType : "application/json; charset=utf-8",
				success : function(resp) {
					// we have the response  
					alert("Guest Deleted");
					loadGuests();
				},
				error : function(jqXHR, exception) {
					alert("Error Deleting Guest");
					console.log(jqXHR.responseText);

				},
			       beforeSend : setHeader
			});
		} else {
			txt = "You pressed Cancel!";
		}
	}

	function editGuest(id) {
		localStorage.editGuestId = id;

				document.location.href = "/StudentRest-HTML-JPA/WebContent/EditGuest.html",
				true;
	}
	$(function(){
	    $('#btnImport').click(upload);
	});

	function upload(){
		console.log("Uploading....");
	    var file = $('input[name="inputFileUpload"]').get(0).files[0];
	 
	    var formData = new FormData();
	    formData.append('file', file);
	    var id = localStorage.event;
		var url = '/SchoolRestJPA/rest/tabletopservices/events/' + id + '/upload';
	    $.ajax({
	        url: url,
	        type: 'POST',
	        data: formData,
	        cache: false,
	        contentType: false,
	        processData: false,
	        success: function(){
	            alert('file upload complete');
	            loadGuests();
	        },
	        error: function(response){
	            var error = "error";
	            if (response.status === 409){
	                error = response.responseText;
	            }
	            alert(error);
	        }	       
	    });
	}
</script>

<!--   <select> -->
<!--     <option data-value='{"name":"rajiv","age":"40"}'>a</option> -->
<!--     <option data-value='{"name":"mithun","age":"22"}'>f</option> -->
<!-- </select> -->
  <div id="nav-container">

  </div>
    <div class="container">
	<div class="row">
	 <h2>Edit Event</h2>
	</div>
	<div class="row">
	<div class="pull-right">
		<a href="javascript:seatingArrangement()" id="btnSeatingArrangement" class="btn btn-info btn-sm">Seating Arrangement</a>
	</div>
	</div>
		<div class="row">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">Event Info</h3>
				</div>
				<div class="panel-body">

					<div class="row">
						<div class="col-sm-12 col-md-12 col-lg-12">
							<form  method="post" id="editEventForm" class="form-horizontal">
								<fieldset>
									<input type="hidden" id="inputEventID" name="eventId" val="" >
									<div class="form-group">
										<label for="inputEventTitle" class="col-lg-2 control-label">
											Event Title
										</label>
										<div class="col-lg-10">
											<input type="text" class="form-control" id="inputTitle" name="eventTitle"	placeholder="Event Title">
										</div>
									</div>
									<div class="form-group">
										<label for="inputVenueName" class="col-lg-2 control-label">
											Venue Name
										</label>
										<div class="col-lg-10">
											<input type="text" class="form-control" id="inputVenueName" name="venueName"
												placeholder="Venue Name">
										</div>
									</div>
									<div class="form-group">
										<label for="inputEventDate" class="col-lg-2 control-label">Event
											Date/Time</label>
										<div class="col-lg-10">
											<div class="col-sm-6 col-md-6 col-lg-6">
											<div class="input-group">
												<input type="datetime" class="form-control date-input" id="inputEventDate" name="EventDate" placeholder="Event Date/Time">
												<span class="input-group-addon">
        												<span class="glyphicon glyphicon-calendar"></span>
    											</span>
											</div>
											</div>
										
										<div class="col-sm-6 col-md-6 col-lg-6">
												<div class="input-group clockpicker " data-autoclose="true">
    												<input type="time" class="form-control" id="inputEventTime" name="inputEventTime" value="">
    												<span class="input-group-addon">
        												<span class="glyphicon glyphicon-time"></span>
    												</span>
												</div>	
										</div>
										</div>
									</div>
									<div class="form-group">
										<label for="selectClientName" class="col-lg-2 control-label">Client
											Name</label>
										<div class="col-lg-10">
											<select class="form-control" id="selectClientName" name="EventTime">
											
											</select>
										</div>
									</div>
									
									<div class="form-group">
										<label for="selectPrimaryPlanner"
											class="col-lg-2 control-label">Primary Planner</label>
										<div class="col-lg-10">
											<select class="form-control" id="selectPrimaryPlanner" name="primaryPlanner">
												
											</select>
										</div>
									</div>
									
									<div class="form-group">
										<label for="inputTableSize" class="col-lg-2 control-label">Table
											Size</label>
										<div class="col-lg-10">
											<input type="text" class="form-control" id="inputTableSize"
												placeholder="Table Size">
										</div>
									</div>
									
									<div class="form-group">
										<label for="inputTableEmptySpots"
											class="col-lg-2 control-label">Max Empty Seats</label>
										<div class="col-lg-10">
											<input type="text" class="form-control"
												id="inputTableEmptySpots" placeholder="Max Empty Seats">
										</div>
									</div>
							<div class="btn-group pull-right">
										<div class="col-md-12 col-lg-12 ">
											<button id="btnSubmit" type="submit" class="btn btn-primary">Submit</button>
											<button type="reset" id="btnCancel" class="btn btn-default">Cancel</button> 
										</div>
								</div>
								</fieldset>

							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		
		
		
		
		<div class="row">
			<div id="guestsPanel" class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">Guests</h3>
				</div>
				<div class="panel-body">
					<div class="row">
						<a href="javascript:editGuest(0)" id="btnNewGuest" class="btn btn-xs btn-primary pull-right"><i class="glyphicon glyphicon-plus"></i>New Guest</a>
						<div class="form-inline">
							<div class="input-group input-group-sm">
<!-- 								<input type="text" class=""	placeholder="Import from file"> -->
<!-- 								<div class="input-group-btn"> -->
<!-- 									<label class="btn btn-default btn-sm btn-file"> Browse -->
										<input type="file" id="inputFileUpload" name="inputFileUpload" />
<!-- 									</label> -->
<!-- 								</div> -->
							</div>
							<button id="btnImport" type="button" class="btn btn-sm btn-success">Import</button>
						</div>
					</div>
						<hr>
					<div class="row">
						<table class="table table-striped table-hover ">
							<thead>
								<tr>
									<th>Name</th>
									<th>Relationship to Client</th>
								</tr>
							</thead>
							<tbody id="guestsTable">
								
							</tbody>
						</table>
						 <ul id="pagination" class="pagination-sm"></ul>
					</div>
				</div>
			</div>

		</div>
	
	</div><!-- /.container -->
	
<!--     <script src="http://code.jquery.com/jquery.js"></script> -->
 
    <script type="text/javascript">
			$('.clockpicker').clockpicker();
			$("#inputEventDate").datepicker();
				
	</script>
  </body>
</html>