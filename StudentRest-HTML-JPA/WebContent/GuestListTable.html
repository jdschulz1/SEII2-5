<!DOCTYPE html>
<html>
<head>
<title>Tabletops</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap -->
<link href="css/bootstrap.css" rel="stylesheet" media="all">
<link href="css/Site.css" rel="stylesheet" media="all">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script type="text/javascript">
	$(document).ready(function() {
		$('#nav-container').load('nav.html');
		localStorage.tablesNavSelect = "btnGuestListView";
		$('#tables-nav').load('TablesNav.html');
		loadUsersTable();
	});
</script>
</head>
<body>
	<script type="text/javascript">
	function getCookie(cname) {
		console.log("get cookie");
		var name = cname + "=";
		var decodedCookie = decodeURIComponent(document.cookie);
		var ca = decodedCookie.split(';');
		for (var i = 0; i < ca.length; i++) {
			var c = ca[i];
			while (c.charAt(0) == ' ') {
				c = c.substring(1);
			}
			if (c.indexOf(name) == 0) {
				return c.substring(name.length, c.length);
			}
		}
		return "";
	}

	function setHeader(xhr) {
		console.log("set Header");
		token = getCookie("token");
		console.log("Token: " + token);
		xhr.setRequestHeader('Authorization', 'Bearer ' + token);
	}
		function loadUsersTable() {

			var id = localStorage.eventId;
			if (id > 0) {
				var guestsUrl = "/SchoolRestJPA/rest/tabletopservices/events/"
						+ id + "/guests";

				$.ajax({
							type : "GET",
							url : guestsUrl,
							dataType : "json",
							statusCode : {
								401 : function(response) {
									$('#page-message').html("You must Login first");
									alert("Please login to access this page");
						        	document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
								},
								405 : function(response) {
									$('#page-message').html(
											"Access to the page forbiden");
									alert("Please login to access this page");
									document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
								}
							},
							success : function(resp) {
								// we have the response  

								$('#guest_table')
										.html(
												'<thead><tr><th>Guest Name</th><th>Table</th></tr></thead>');

								var guests = [];
								var keys = [];

								$.each(resp, function(i, guest) {
									if (guest.eventTableNumber == null){
						        		alert("No table for guest " + guest.name);	
						        	}else{
										guests[guest.name] = guest;
										keys.push(guest.name);
						        	}
								});

								console.log(guests);
								console.log(keys);
								keys.sort();
								var tableRow;

								for (var i = 0; i < keys.length; i++) {
									var key = keys[i];
									var guest = guests[key];
									console.log(guest);
									tableRow = "<tr>" 
											+ "<td>" + guest.name + "</td>" 
											+ "<td>" + guest.eventTableNumber + "</td>"
											+ "</tr>";

									$('#guest_table').append(tableRow);
								}
							},
							error : function(jqXHR, exception) {

								alert(jqXHR.responseText);
							},
						       beforeSend : setHeader
						});
			}
		}
	</script>
	<div id="nav-container"></div>
	<div class="col-sm-12 col-md-12 col-lg-12">
		<h1>Seating Arrangement</h1>
		<div id="tables-nav"></div>
		<div class="container">
			<div class="row">
				<h1>Guests</h1>
				<button class="btn btn-xs btn-default pull-right" onclick="window.print();">Print</button>
			</div>
			<hr />

			<div class="row">
				<table class="table table-striped table-hover" id="guest_table"></table>
			</div>
		</div>
	</div>
	<script src="http://code.jquery.com/jquery.js"></script>
	<script src="js/bootstrap.min.js"></script>
</body>
</html>