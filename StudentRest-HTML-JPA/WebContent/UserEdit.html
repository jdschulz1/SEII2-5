<!DOCTYPE html>
<html>
  <head>
    <title>Tabletops</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="css/bootstrap.css" rel="stylesheet" media="screen">
    <link href="css/Site.css" rel="stylesheet" media="screen">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script type="text/javascript">
		$(document).ready(function() {
			$('#nav-container').load('nav.html');
			loadUserFromLocalStorage();
		});
	</script>
  </head>
  <body>
  <script type="text/javascript">
  function getCookie(cname) {
		console.log("get cookie");
		var name = cname + "=";
		var decodedCookie = decodeURIComponent(document.cookie);
		var ca = decodedCookie.split(';');
		for (var i = 0; i < ca.length; i++) {
			var c = ca[i];
			while (c.charAt(0) == ' ') {
				c = c.substring(1);
			}
			if (c.indexOf(name) == 0) {
				return c.substring(name.length, c.length);
			}
		}
		return "";
	}

	function setHeader(xhr) {
		console.log("set Header");
		token = getCookie("token");
		console.log("Token: " + token);
		xhr.setRequestHeader('Authorization', 'Bearer ' + token);
	}
  function loadUserFromLocalStorage(){
	  var id = localStorage.user;
		if(id > 0){
			var clientUrl = "/SchoolRestJPA/rest/tabletopservices/users/" + id;
			
		 	$.ajax({
		 		type: 'GET',
		 		url: clientUrl,  
		 	    dataType: "json",
		 	   statusCode : {
					401 : function(response) {
						$('#page-message').html("You must Login first");
						alert("Please login to access this page");
			        	document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
					},
					405 : function(response) {
						$('#page-message').html(
								"Access to the page forbiden");
						alert("Please login to access this page");
						document.location.href = "/StudentRest-HTML-JPA/WebContent/Login.html", true;
					}
				},
		         success: function (data) {
		        	 //alert("success");
		        	 console.log(JSON.stringify(data));
		        	$("#inputUserID").val(id);
		        	$("#inputName").val(data.name);
		         	$("#inputUsername").val(data.userName);
		         	$("#inputRole").val(data.role).change();
		         	$("#inputPassword").val(data.password);
		         	$("#inputVerifyPassword").val(data.password);
		         	$("#inputEmail").val(data.email);
		         },
		         error: function (jqXHR, exception) {
		    	    
		     	    alert("Load User Error" + jqXHR.responseText);
		     	  },
			       beforeSend : setHeader  
		     });
		}
  }
  $(document).ready(function() { 
	$("#btnCancel").click(function(e){
		document.location.href = "/StudentRest-HTML-JPA/WebContent/UserList.html", true;
	});  
  	$("#editUserForm").submit(function(e){
	  e.preventDefault();
	  // Get form
      	var data = {};
    	var Form = this;
		
    	//Gathering the Data
    	//and removing undefined keys(buttons)
    	$.each(this.elements, function(i, v){
            var input = $(v);
        	data[input.attr("name")] = input.val();
        	
        	delete data["undefined"];
    	});
		
      $("#btnSubmit").prop("disabled", true);
      
      
	  var userID = $("#inputUserID").val();
	  console.log(JSON.stringify(data));
	  if(userID > 0){
		  console.log(JSON.stringify(data));
		  var url =  "/SchoolRestJPA/rest/tabletopservices/users/" + userID;	  
			$.ajax({
	          type: "PUT",
	          url: url,
	          contentType: "application/json; charset=utf-8",
	          dataType:"json",
	          statusCode : {
					403 : function(response) {
						$('#page-message').html("Access Denied");
						alert("You must have admin credentials to perform this action");
					},
	          },
	          data: JSON.stringify(data),          
	          cache: false,
	          context : Form,
	          success: function (data) {
	        	  $('#successMessages').fadeIn().html(data);
	        	  setTimeout(function() {
						$('#successMessages').fadeOut("slow");
					}, 2000 );
	        	  alert("User Data Saved");
	        	  document.location.href = "/StudentRest-HTML-JPA/WebContent/UserList.html", true; 
	              $("#btnSubmit").prop("disabled", false);
	          },
	          error: function (e) {
	              console.log("ERROR : ", e.responseText);
	              alert("There was an error saving the user.");
	              $("#btnSubmit").prop("disabled", false);
	          },
		       beforeSend : setHeader
	      });
	  }else{ //new user
	
		  var url =  "/SchoolRestJPA/rest/tabletopservices/users";	  
			$.ajax({
	          type: "POST",
	          url: url,
	          contentType: "application/json; charset=utf-8",
	          dataType:"json",
	          statusCode : {
					403 : function(response) {
						$('#page-message').html("Access Denied");
						alert("You must have admin credentials to perform this action");
					},
	          },
	          data: JSON.stringify(data),          
	          cache: false,
	          context : Form,
	          success: function (data) { 
	        	  alert("User Data Saved");
	        	  document.location.href = "/StudentRest-HTML-JPA/WebContent/UserList.html", true; 
	              $("#btnSubmit").prop("disabled", false);
	          },
	          error: function (e) {
	        	  console.log("ERROR : ", e.responseText);
	              alert("There was an error saving the user.");
	              console.log("ERROR : ", e.responseText);
	              $("#btnSubmit").prop("disabled", false);
	          },
		       beforeSend : setHeader
	      });
	  }
	  
	  
  	});
  });
  </script>
    <div id="nav-container">

  	</div>

    <div class="container">


		<div class="row">
			<h1>Edit User</h1>
		</div>
		<div class="row">
<form id="editUserForm" class="form-horizontal">
  <fieldset>
   	<input type="hidden" id="inputUserID" name="userId" val=""></input>
    <div class="form-group">
      <label for="inputName" class="col-lg-2 control-label">Name</label>
      <div class="col-lg-10">
        <input type="text" class="form-control" id="inputName" name="name" placeholder="Name">
      </div>
    </div>
    <div class="form-group">
      <label for="inputUsername" class="col-lg-2 control-label">Username</label>
      <div class="col-lg-10">
        <input type="text" class="form-control" id="inputUsername" name="userName" placeholder="Username">
      </div>
    </div>
     <div class="form-group">
      <label for="inputPassword" class="col-lg-2 control-label">Password</label>
      <div class="col-lg-10">
        <input type="password" class="form-control" id="inputPassword" name="password" placeholder="Password">
      </div>
    </div>
       <div class="form-group">
      <label for="inputVerifyPassword" class="col-lg-2 control-label">Verify Password</label>
      <div class="col-lg-10">
        <input type="password" class="form-control" id="inputVerifyPassword" placeholder="Verify Password">
      </div>
    </div>
   
    <div class="form-group">
		<label for="inputRole"  class="col-lg-2 control-label">Role</label>
										<div class="col-lg-10">
											<select name="role" class="form-control" id="inputRole" >
												<option value="user">user</option>
												<option value="admin">admin</option>
											</select>
										</div>
									</div>
    <div class="form-group">
      <label for="inputEmail" class="col-lg-2 control-label">Email</label>
      <div class="col-lg-10">
        <input type="text" class="form-control" id="inputEmail" name="email" placeholder="Email">
      </div>
    </div>
  
      <div class="col-lg-12 col-lg-12">
       <div class="form-group pull-right">
      <div class="btn-block">
        <button id="btnSubmit" type="submit" class="btn btn-sm btn-primary">Submit</button>
        <button type="reset" id="btnCancel" class="btn btn-sm btn-default">Cancel</button>
        </div>
      </div>
    </div>
</fieldset>

</form>
	</div>
	</div><!-- /.container -->
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
  </body>
</html>